# 达梦数据库V8单机安装及基本使用

**视频教程**：[达梦数据库V8单机安装及基本使用](https://mp.weixin.qq.com/s/W2Y5jTRVDWgHv_GPn8VoMg)

## 前置准备

CentOS7.9、dm8_20221020_x86_rh6_64.iso

想要完成本期视频中所有操作，需要有一定的Linux、MySQL或Oracle基础。

> [Linux下jdk的安装](https://mp.weixin.qq.com/s/WNS9Ho-UWesQifwk4FjxQQ)

## 一、概述

达梦数据库创始人冯裕才，1988年，我国第一个拥有自主版权的国产数据库管理系统原型CRDS获得成功。1992年，华中理工大学达梦数据库研究所成立，随后承担起众多国家级、部级重大项目。2000年，我国第一个数据库公司-武汉华工达梦数据库有限公司成立。

![xiaokangxxs-image-20221123191753107](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221123191753107.ylhjyn99cts.jpg)

DM8是达梦公司在总结DM系列产品研发与应用经验的基础上，坚持开放创新、简洁实用的理念，推出的新一代自研数据库。DM8吸收借鉴当前先进新技术思想与主流数据库产品的优点，融合了分布式、弹性计算与云计算的优势，对灵活性、易用性、可靠性、高安全性等方面进行了大规模改进，多样化架构充分满足不同场景需求，支持超大规模并发事务处理和事务-分析混合型业务处理，动态分配计算资源，实现更精细化的资源利用、更低成本的投入。一个数据库，满足用户多种需求，让用户能更加专注于业务发展。  

## 二、安装前检查

### 2.1 下载安装包

https://www.dameng.com/list_103.html

下载地址：[https://download.dameng.com/eco/adapter/DM8/202211/dm8_20221020_x86_rh6_64_ent.zip](https://download.dameng.com/eco/adapter/DM8/202211/dm8_20221020_x86_rh6_64_ent.zip)

![xiaokangxxs-image-20221123191423111](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221123191423111.tlldoiiorw0.jpg)

检查数字签名校验：

```shell
[root@hadoop ~]# sha256sum /data/package/dm8_20221020_x86_rh6_64_ent/dm8_20221020_x86_rh6_64.iso
[root@hadoop ~]# cat /data/package/dm8_20221020_x86_rh6_64_ent/dm8_20221020_x86_rh6_64.iso_SHA256.txt
```

![xiaokangxxs-image-20221126193449919](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126193449919.2y76d4gud0k0.jpg)

### 2.2 检查系统信息

执行以下命令查看系统信息：

```shell
#获取系统位数 
[root@hadoop ~]# getconf LONG_BIT
#查询系统信息 
[root@hadoop ~]# cat /etc/redhat-release
#查询系统名称 
[root@hadoop ~]# uname -a
```

![xiaokangxxs-image-20221126183209594](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126183209594.2kmegba6xse0.jpg)

### 2.3 创建用户

为了减少对操作系统的影响，用户不应该以 root 系统用户来安装和运行 DM，为 DM 创建一个专用的系统用户**dmdba**

```shell
# 1. 创建安装用户组 dinstall
[root@hadoop ~]# groupadd -g 11241 dinstall
# 2. 创建安装用户 dmdba 
[root@hadoop ~]# useradd -u 11241 -g dinstall -m -d /home/dmdba -s /bin/bash dmdba
# 3. 初始化用户密码
[root@hadoop ~]# passwd dmdba
```

![xiaokangxxs-image-20221126184340572](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126184340572.5lfhvgb3bp80.jpg)

### 2.4 系统限制修改

```shell
[root@hadoop ~]# ulimit -a

core file size          (blocks, -c) 0
# 设置为 1048576(即1GB)以上或 unlimited(无限制)，此参数过小将导致数据库启动失败
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
# 设置为 unlimited(无限制)，此参数过小将导致数据库安装或初始化失败
file size               (blocks, -f) unlimited
pending signals                 (-i) 31118
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
# 设置为 65536以上或unlimited(无限制)
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 31118
# 设置为 1048576(即1GB)以上或 unlimited(无限制)，此参数过小将导致数据库启动失败
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

针对 open files 的值，修改/etc/security/limits.conf，在文件最后加入以下内容：

```shell
* soft nofile 65536
* hard nofile 65536
* soft nproc 65536
* hard nproc 65536
```

![xiaokangxxs-image-20221126190514413](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126190514413.2l2xyomnsqa0.jpg)

### 2.5 内存与存储空间

操作系统至少1GB的可用内存(RAM)，DM完全安装需要1GB的存储空间，同时DM 安装程序在安装时将产生临时文件，临时文件需要 1GB的存储空间。

本次演示机器配置为8C8G，/目录40GB，/data目录50GB，临时文件默认是/tmp，也可以通过环境变量DM_INSTALL_TMPDIR指定，如果指定了环境变量则需要提前创建好对应目录。

![xiaokangxxs-image-20221126191703872](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126191703872.6dgcwui9pog0.jpg)

### 2.6 设置JAVA环境

编辑/etc/profile.d/env_global_xiaokangxxs.sh文件，加入环境变量DM_JAVA_HOME：

```shell
# 达梦相关
export DM_INSTALL_TMPDIR=/data/tmp
export DM_JAVA_HOME=/opt/moudle/jdk-1.8.0_202
export PATH=${DM_JAVA_HOME}/bin:$PATH
```

修改完成后，source使其生效，通过以下命令检查是否生效：

```shell
[root@hadoop ~]# echo $DM_JAVA_HOME
/opt/moudle/jdk-1.8.0_202
```

创建自定义临时目录并授权：

```shell
[root@hadoop ~]# mkdir -p /data/tmp
[root@hadoop ~]# mkdir -p /data/dm8
[root@hadoop ~]# chown -R dmdba.dinstall /data/dm8
[root@hadoop ~]# chown -R dmdba.dinstall /data/tmp
```

## 三、安装DM

### 3.1 挂载iso光驱

使用**root**用户执行以下命令：

```shell
# 创建一个用于挂载光驱的目录
[root@hadoop ~]# mkdir /data/package/iso
# 挂载光驱
[root@hadoop ~]# mount -o loop /data/package/dm8_20221020_x86_rh6_64_ent/dm8_20221020_x86_rh6_64.iso /data/package/iso/
```

![xiaokangxxs-image-20221126194009399](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126194009399.1g8a9fvdys0w.jpg)

### 3.2 命令行安装

切换到dmdba用户，开始安装：

```shell
[dmdba@hadoop ~]$ cd /data/package/iso/
[dmdba@hadoop iso]$ ./DMInstall.bin -i
```

![xiaokangxxs-image-20221126195512768](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126195512768.3p1hj9dye1q.jpg)![xiaokangxxs-image-20221126195714258](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126195714258.4t97vjllhqg0.jpg)

### 3.3 DmAPService服务脚本

DmAPService是达梦数据库辅助插件服务，使用**root**用户执行以下命令：

```shell
[root@hadoop ~]# sh /data/dm8/dinstall/script/root/root_installer.sh
[root@hadoop ~]# systemctl status DmAPService
```

![xiaokangxxs-image-20221126200112350](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126200112350.4m0dydll1060.jpg)

### 3.4 配置环境变量

编辑/etc/profile.d/env_global_xiaokangxxs.sh文件，加入达梦相关环境变量：

```shell
# 达梦相关
export DM_INSTALL_TMPDIR=/data/dm8/tmp
export DM_JAVA_HOME=/opt/moudle/jdk-1.8.0_202
export LD_LIBRARY_PATH=/data/dm8/dinstall/bin
export DM_HOME=/data/dm8/dinstall
export PATH=${DM_HOME}/bin:${DM_HOME}/tool:${DM_JAVA_HOME}/bin:${LD_LIBRARY_PATH}:$PATH
```

修改完成后，source使其生效。

## 四、初始化数据库与注册服务

### 4.1 初始化XIAOKANG数据库实例

使用dmdba用户执行以下命令：

```shell
# 初始化XIAOKANG数据库实例，参考DM8_dminit使用手册
[dmdba@hadoop ~]$ dminit path=/data/dm8/data DB_NAME=XIAOKANG INSTANCE_NAME=XIAOKANG PAGE_SIZE=32 EXTENT_SIZE=64 CASE_SENSITIVE=N LENGTH_IN_CHAR=1 CHARSET=1 PORT_NUM=5238 SYSDBA_PWD=Xiaokang_202211 SYSAUDITOR_PWD=Xiaokang_202211
```

![xiaokangxxs-image-20221126201312178](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126201312178.285b22jlubdw.jpg)

### 4.2 注册XIAOKANG数据库实例服务

使用root用户执行以下命令：

```shell
# 注册XIAOKANG数据库实例服务，参考DM8_Linux服务脚本使用手册
[root@hadoop root]# cd /data/dm8/dinstall/script/root
[root@hadoop root]# ./dm_service_installer.sh -t dmserver -dm_ini /data/dm8/data/XIAOKANG/dm.ini -p XIAOKANG
```

![xiaokangxxs-image-20221126201818548](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126201818548.7eepern330g0.jpg)

### 4.3 启动XIAOKANG数据库实例服务

使用root用户执行以下命令：

```shell
[root@hadoop root]# systemctl status DmServiceXIAOKANG
[root@hadoop root]# systemctl start DmServiceXIAOKANG
[root@hadoop root]# systemctl status DmServiceXIAOKANG
[root@hadoop root]# systemctl is-enabled DmServiceXIAOKANG
[root@hadoop root]# ps -ef|grep dmserver
```

![xiaokangxxs-image-20221126202111972](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126202111972.78wp0d6g09w0.jpg)

![xiaokangxxs-image-20221126202259749](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126202259749.1isjneg59gtc.jpg)

## 五、基本使用

### 5.1 连接达梦数据库

```shell
[dmdba@hadoop ~]$ disql SYSDBA/Xiaokang_202211@192.168.73.188:5238
或者
[dmdba@hadoop ~]$ disql SYSDBA/Xiaokang_202211@127.0.0.1:5238
```

![xiaokangxxs-image-20221126202713430](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221126202713430.4pc0rqjm8g40.jpg)

### 5.2 DDL/DML/DQL/DCL

```sql
-- DDL
create tablespace xiaokang_system datafile 'xiaokang_system.dbf' size 200 autoextend on maxsize 10240;
create user xiaokang_system identified by "xiaokang_202211" default tablespace xiaokang_system default index tablespace xiaokang_system;
--DCL
grant "RESOURCE","PUBLIC","DBA","VTI" to xiaokang_system;
CREATE TABLE Account (ID INT NOT NULL,NAME VARCHAR(20)); --DDL
-- DML
INSERT INTO Account VALUES (1124,'xiaokang');
INSERT INTO Account VALUES (1125,'xiaokangxxs');
ALTER TABLE "xiaokang_system"."Account" ADD COLUMN "id" identity(1, 1); -- DDL
INSERT INTO Account (name) VALUES('zhangsan');
INSERT INTO Account (name) VALUES('lisi');
INSERT INTO Account (name) VALUES('wangwu');
UPDATE Account SET "name"='lisi888' WHERE id=1127;
DELETE FROM Account WHERE id=1128;
DROP user xiaokang_system cascade; -- DDL
DROP tablespace xiaokang_system; -- DDL
--DQL
-- 查询Account表所有数据
select * from Account;
-- 查看数据库版本信息
select * from v$version;
-- 查看账号状态
select username,account_status,lock_date from dba_users;
-- 查看表空间的状态       
select tablespace_name,decode(status,'0','正常','1','异常','2','异常') as status from dba_tablespaces;
-- 查看数据库状态与模式
select name,instance_name,status$,mode$ from v$instance;
-- 查看表空间使用情况
select
        c.name          ,
        d.total total_MB,
        d.free free_MB  ,
        d.used used_MB  ,
        round(d.used_per, 2)
        ||'%' used_per,
        e.max_size/1024 MAX_DATAFILE_GB
from
        V$TABLESPACE c
join
        (
                SELECT
                        a.id                                                                                ,
                        sum(b.total_size)*b.page_size/1024/1024 total                                       ,
                        sum(b.free_size) *b.page_size/1024/1024 free                                        ,
                        sum(b.total_size)*b.page_size/1024/1024-sum(b.free_size) *b.page_size/1024/1024 used,
                        100              -(sum(b.free_size)*100/sum(b.total_size)) used_per
                FROM
                        V$TABLESPACE a,
                        V$DATAFILE b
                where
                        a.id=b.GROUP_ID
                group by
                        a.id,
                        b.page_size
        )
        d
on
        c.id=d.id
left join v$datafile e
on
        c.id = e.group_id
order by
        round(d.used_per, 2) desc;
```

![xiaokangxxs-image-20221127100554941](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221127100554941.4hy2ivv512g0.jpg)

![xiaokangxxs-image-20221127100849497](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221127100849497.7f94q22fb2c0.jpg)

![xiaokangxxs-image-20221127101046478](https://cdn.staticaly.com/gh/xiaokangxxs/images@master/dm/xiaokangxxs-image-20221127101046478.6vcwjnduiso0.jpg)